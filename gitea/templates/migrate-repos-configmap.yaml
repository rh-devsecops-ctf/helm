{{- if and .Values.gitea.repositories.migrateViaJob.enabled .Values.gitea.repositories.migrateViaJob.repositoriesList .Values.gitea.users.createAdmin }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.gitea.name }}-migrate-repos
  namespace: {{ .Values.gitea.namespace }}
  labels:
    app.kubernetes.io/component: gitea-migrate-repos
data:
  # Single-line JSON so the mounted file is parsed reliably by jq
  repos.json: {{ .Values.gitea.repositories.migrateViaJob.repositoriesList | toJson | quote }}
  migrate.sh: |
    #!/bin/bash
    set -e
    GITEA_URL="${GITEA_URL}"
    GITEA_ADMIN_USER="${GITEA_ADMIN_USER}"
    GITEA_ADMIN_PASSWORD="${GITEA_ADMIN_PASSWORD}"
    REPOS_FILE="/config/repos.json"
    PREFIX="${PREFIX}"
    USER_COUNT="${USER_COUNT:-1}"

    echo "Waiting for Gitea at $GITEA_URL..."
    until curl -sfk -o /dev/null --connect-timeout 5 -u "$GITEA_ADMIN_USER:$GITEA_ADMIN_PASSWORD" "$GITEA_URL/api/v1/version" 2>/dev/null; do
      echo "Gitea not ready, retrying in 10s..."
      sleep 10
    done
    echo "Gitea is ready."

    if [ ! -f "$REPOS_FILE" ] || [ ! -s "$REPOS_FILE" ]; then
      echo "Missing or empty $REPOS_FILE."
      exit 1
    fi
    REPO_COUNT=$(jq -r 'length' "$REPOS_FILE" 2>/dev/null || echo "0")
    echo "Repos in list: $REPO_COUNT"
    if [ "$REPO_COUNT" = "0" ] || [ "$REPO_COUNT" = "null" ]; then
      echo "No repositories in $REPOS_FILE - check values (gitea.repositories.migrateViaJob.repositoriesList). First 200 chars: $(head -c 200 "$REPOS_FILE")."
      exit 1
    fi

    per_user_filter='.[] | select(.perUser == true)'
    global_filter='.[] | select(.perUser != true)'

    if jq -e '[.[] | select(.perUser == true)] | length > 0' "$REPOS_FILE" 2>/dev/null >/dev/null; then
      first_user="${PREFIX}1"
      echo "Waiting for first user $first_user..."
      for i in 1 2 3 4 5 6 7 8 9 10 11 12; do
        if curl -sfk -u "$GITEA_ADMIN_USER:$GITEA_ADMIN_PASSWORD" "$GITEA_URL/api/v1/users/$first_user" >/dev/null 2>&1; then
          echo "User $first_user exists."
          break
        fi
        [ "$i" -eq 12 ] && { echo "Timeout waiting for user $first_user"; exit 1; }
        sleep 10
      done
    fi

    migrate_one() {
      repo_owner="$1"
      repo_name="$2"
      clone_addr="$3"
      private="$4"
      body=$(jq -n \
        --arg addr "$clone_addr" --arg name "$repo_name" --arg owner "$repo_owner" \
        --argjson priv "$private" \
        '{clone_addr:$addr,repo_name:$name,repo_owner:$owner,private:priv}')
      http=$(curl -sk -w "%{http_code}" -o /tmp/migrate_out -X POST \
        -u "$GITEA_ADMIN_USER:$GITEA_ADMIN_PASSWORD" \
        -H "Content-Type: application/json" \
        -d "$body" \
        "$GITEA_URL/api/v1/repos/migrate")
      if [ "$http" = "201" ]; then
        echo "Migrated: $repo_owner/$repo_name"
      elif [ "$http" = "409" ] || [ "$http" = "422" ]; then
        echo "Already exists or conflict (HTTP $http): $repo_owner/$repo_name"
      else
        echo "Migration failed (HTTP $http): $repo_owner/$repo_name"
        cat /tmp/migrate_out
        return 1
      fi
    }

    # Per-user repos: use process substitution so migrate_one runs in main shell
    n=1
    while [ "$n" -le "$USER_COUNT" ]; do
      username="${PREFIX}${n}"
      while read -r repo; do
        name=$(echo "$repo" | jq -r '.name')
        clone_addr=$(echo "$repo" | jq -r '.repo')
        private=$(echo "$repo" | jq -r '.private // false')
        repo_name="${username}-${name}"
        migrate_one "$username" "$repo_name" "$clone_addr" "$private"
      done < <(jq -c "$per_user_filter" "$REPOS_FILE" 2>/dev/null)
      n=$((n + 1))
    done

    # Global repos
    while read -r repo; do
      name=$(echo "$repo" | jq -r '.name')
      clone_addr=$(echo "$repo" | jq -r '.repo')
      private=$(echo "$repo" | jq -r '.private // false')
      owner=$(echo "$repo" | jq -r '.owner // ""')
      [ -z "$owner" ] && owner="$GITEA_ADMIN_USER"
      migrate_one "$owner" "$name" "$clone_addr" "$private"
    done < <(jq -c "$global_filter" "$REPOS_FILE" 2>/dev/null)

    echo "Repository migration complete."
{{- end }}
