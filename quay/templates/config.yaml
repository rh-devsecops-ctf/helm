{{- define "quay.config.yaml" -}}
SUPER_USERS:
{{- .Values.quay.configBundle.superUsers | toYaml | nindent 2 }}
FEATURE_USER_INITIALIZE: {{ .Values.quay.configBundle.featureUserInitialize | default true }}

FEATURE_PROXY_CACHE: true
FEATURE_QUOTA_MANAGEMENT: true
# Proxy blob downloads through Quay instead of redirecting to S3/MinIO. Avoids 403 (e.g. SignatureDoesNotMatch)
# when MinIO is behind a route or presigned URLs fail.
FEATURE_PROXY_STORAGE: true

REGISTRY_TITLE: {{ .Values.quay.configBundle.registryTitle | quote }}
SERVER_HOSTNAME: {{ tpl .Values.quay.configBundle.serverHostname . | quote }}
EXTERNAL_TLS_TERMINATION: true

QUAY_FEATURES: "s3_storage,clair_integration,redis_cache,robot_accounts,quay_config_updater"

# Required for Quay: use RadosGWStorage for S3-compatible backends (e.g. MinIO).
# Use internal MinIO host when quayS3UseInternalHost is true to avoid SignatureDoesNotMatch 403
# (presigned URLs and Clair layer fetch use the same host Quay connects to).
{{- $useInternal := .Values.quay.configBundle.quayS3UseInternalHost }}
{{- $s3Host := ternary (.Values.quay.configBundle.quayS3InternalHost | default "minio.minio.svc.cluster.local") (tpl (.Values.quay.configBundle.quayS3Hostname | default (printf "minio-api.%s" (.Values.subDomain | default "cluster.local"))) .) $useInternal }}
{{- $s3Port := ternary (.Values.quay.configBundle.quayS3InternalPort | default "9000") (.Values.quay.configBundle.quayS3Port | default "443") $useInternal }}
{{- $s3Secure := ternary false (.Values.quay.configBundle.quayS3Secure | default true) $useInternal }}
DISTRIBUTED_STORAGE_CONFIG:
  default:
    - RadosGWStorage
    - access_key: {{ .Values.quay.configBundle.quayS3AccessKey | quote }}
      bucket_name: {{ .Values.quay.configBundle.quayS3BucketName | default "quay" | quote }}
      hostname: {{ $s3Host | quote }}
      is_secure: {{ $s3Secure }}
      port: {{ $s3Port | quote }}
      secret_key: {{ .Values.quay.configBundle.quayS3SecretKey | quote }}
      storage_path: {{ .Values.quay.configBundle.quayS3StoragePath | default "/datastorage/registry" | quote }}
      signature_version: s3v4
DISTRIBUTED_STORAGE_DEFAULT_LOCATIONS: []
DISTRIBUTED_STORAGE_PREFERENCE:
  - default

{{- end -}}

